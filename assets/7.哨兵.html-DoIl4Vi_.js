import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as n,b as l,o as s}from"./app-CxCOPEY5.js";const a={};function t(d,e){return s(),n("div",null,e[0]||(e[0]=[l(`<h1 id="_7-哨兵" tabindex="-1"><a class="header-anchor" href="#_7-哨兵"><span>7.哨兵</span></a></h1><h2 id="作用" tabindex="-1"><a class="header-anchor" href="#作用"><span>作用</span></a></h2><ul><li>主从监控：监控主从redis库运行是否正常</li><li>消息通知：哨兵可以将故障转移的结果发送给客户端</li><li>故障转移：如果master异常，则会进行主从切换，将其中一个slave作为新- master</li><li>配置中心：客户端通过连接哨兵来获得当前Redis服务的主节点地址</li></ul><h2 id="启动" tabindex="-1"><a class="header-anchor" href="#启动"><span>启动</span></a></h2><p>建议至少三个，且为奇数个</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>redis-sentinel /path/to/sentinel.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>或</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>redis-server /path/to/sentinel.conf --sentinel
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="配置" tabindex="-1"><a class="header-anchor" href="#配置"><span>配置</span></a></h2><h3 id="redis相关" tabindex="-1"><a class="header-anchor" href="#redis相关"><span>redis相关</span></a></h3><p>主库建议设置<code>masterauth</code>，保证主库掉线后作为从库重连可以连接成功</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>masterauth password
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="sentinel相关" tabindex="-1"><a class="header-anchor" href="#sentinel相关"><span>sentinel相关</span></a></h3><p>sentinel能监控多个redis</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 60000
sentinel failover-timeout mymaster 180000
sentinel parallel-syncs mymaster 1

sentinel monitor resque 192.168.1.3 6380 4
sentinel down-after-milliseconds resque 10000
sentinel failover-timeout resque 180000
sentinel parallel-syncs resque 5
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>sentinel monitor <code>&lt;master-name&gt;</code> <code>&lt;ip&gt;</code> <code>&lt;port&gt;</code> <code>&lt;quorum&gt;</code></p><ul><li><code>&lt;quorum&gt;</code>表示最少有几个哨兵认可<strong>客观</strong>下线，同意故障迁移的法定票数</li></ul></li><li><p>sentinel auth-pass <code>&lt;master-name&gt;</code> <code>&lt;password&gt;</code></p></li><li><p>sentinel down-after-milliseconds 指定多少毫秒之后，主节点没有应答哨兵，此时哨兵主观上认为主节点下线</p></li><li><p>sentinel parallel-syncs 表示允许并行同步的slave个数，当Master挂了后，哨兵会选出新的Master，此时，剩余的slave会向新的master发起同步数据</p></li><li><p>sentinel failover-timeout 故障转移的超时时间，进行故障转移时，如果超过设置的毫秒，表示故障转移失败</p></li><li><p>sentinel notification-script 配置当某一事件发生时所需要执行的脚本</p></li><li><p>sentinel client-reconfig-script 客户端重新配置主节点参数脚本</p></li></ul><h3 id="最小配置" tabindex="-1"><a class="header-anchor" href="#最小配置"><span>最小配置</span></a></h3><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>bind 0.0.0.0
daemonize yes 
protected-mode no 
port 26379
logfile &quot;/myredis/sentinel26379.log&quot; 
pidfile /var/run/redis-sentinel26379.pid 
dir /myredis
sentinel monitor mymaster 192.168.111.169 6379 2 
sentinel auth-pass mymaster 111111
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>sentinel 启动后会自动添加部分配置信息</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code># Generated by CONFIG REWRITE
latency-tracking-info-percentiles 50·99·99.9
user default on nopass sanitize-payload~*&amp;*+@a11
sentinel myid·ee7f41ae95e9e80649411a3ea8ada4cfb84c6860 
sentinel current-epoch 2
sentinel known-replica mymaster 192.168.199.224 6380 
sentinel known-replica mymaster 192.168.199.224 6381
sentinel known-sentinel mymaster 192.168.199.224 26381 90329e511cc9c182385608c21dfb8216c03f0a2e 
sentinel known-sentinel &gt; &gt; &gt; mymaster 192.168.199.224 26380 fde3aad96cffb46f0c9bf2f25e2f12f4c921bd30 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h2 id="节点异常" tabindex="-1"><a class="header-anchor" href="#节点异常"><span>节点异常</span></a></h2><h3 id="sentinel日志" tabindex="-1"><a class="header-anchor" href="#sentinel日志"><span>sentinel日志</span></a></h3><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>[018916] 14 Apr 23:32:09.672 # +promoted-slave slave 192.168.199.224:6381 192.168.199.224 6381 @mymaster 192.168.199.224 6379
[018916] 14 Apr 23:32:09.672 # +failover-state-reconf-slaves master mymaster 192.168.199.224 6379
[018916] 14 Apr 23:32:09.734 * +slave-reconf-sent slave 192.168.199.224:6380 192.168.199.224 6380 @mymaster 192.168.199.224 6379
[013636] 14 Apr 23:32:09.734 # +config-update-from sentinel fde3aad96cffb46f0c9bf2f25e2f12f4c921bd30 192.168.199.224 26380@ mymaster 192.168.199.224 6379
[013636] 14 Apr 23:32:09.734 # +switch-master mymaster 192.168.199.224 6379 192.16.199.224 6381
[013636] 14 Apr 23:32:09.734 * +slave slave 192.168.199.224:6380 192.168.199.224 6380@mymaster 192.168.199.224 6381
[013636] 14 Apr 23:32:09.734 * +slave slave 192.168.199.224:6379 192.168.199.224 6379@mymaster 192.168.199.224 6381
[013636] 14 Apr 23:32:9.750  * Sentinel new configuration saved on disk
[018916] 14 Apr 23:32:10.718 * +slave-reconf-inprog slave 192.168.199.224:6380 192.168.199.224 6380@mymaster 192.168.199.224 6379
[018916] 14 Apr 23:32:10.718 * +slave-reconf-done slave 192.168.199.224:6380 192.168.199.224 6380@mymaster 192.168.199.224 6379
[018916] 14 Apr 23:32:10.812 # -odown master mymaster 192.168.199.224 6379 主机真实下线
[018916] 14 Apr 23:32:10.812 # +failover-end master mymaster 192.168.199.224 6379
[018916] 14 Apr 23:32:10.812 # +switch-master mymaster 192.168.199.224 6379 192.168.199.224 6381 选举切换成新主机
[018916] 14 Apr 23:32:10.828 * +slave slave 192.168.199.224:6380 192.168.199.224 6380@mymaster 192.168.199.224 6381
[018916] 14 Apr 23:32:10.828 * ±slave slave 192.168.199.224:6379 192.168.199.224 6379@mymaster 192.168.199.224 6381
[018916] 14 Apr 23:32:10.843 * Sentinel new configuration saved on disk 保存新的sentine1配置文件
[013636] 14 Apr 23:32:14.783 # +sdown slave 192.168.199.224:6379 192.168.199.224 6379@mymaster 192.168.199.224 6381
[018916] 14 Apr 23:32:15.877 # +sdown slave 192.168.199.224:6379 192.168.199.224 6379@mymaster 192.168.199.224 6381
[018916] 14 Apr 23:36:38.308 # +sdown sentinel 90329e511cc9c182385608c21dfb8216c03f0a2e 192.168.199.224 26381 @ mymaster 192.168.199.224 6381
[013636] 14 Apr 23:36:38.340 # +sdown sentinel 90329e511cc9c182385608c21dfb8216c03f0a2e 192.168.199.224 26381@mymaster 192.168.199.224 6381
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="配置文件" tabindex="-1"><a class="header-anchor" href="#配置文件"><span>配置文件</span></a></h3><ul><li><p>master-redis.conf 主库断联后成为从库，但不会自动生成 <code>masterauth</code></p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code># Generated by CONFIG REWRITE 2278
# 从master降级为slave之后，sentinel会制动重写配置文件，让其跟随主机 2279
replicaof 192.168.111.184 6381 
save 3600 1 2280
save 300 100 2281
save 60 10000 2282
latency-tracking- info-percentiles 50 99 99.9 2283
user default on #bcb15f821479b4d5772bd0ca866c00ad5f926e3580720659cc80d39c9d09802a~*&amp;* +@all 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>slave-redis.conf 从库配置文件会被sentinel修改，从库成为主库，<code>replicaof</code> 会被删除</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>＃主从配置
#replicaof 192.168.199.224 6381 slave升级为master之后，跟随主机的配置已经没有了 

masterauth·&quot;123456&quot;
#Generated by CONFIG REWRITE
latency-tracking-info-percentiles 50·99·99.9
user default on sanitize-payload #8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92~*&amp;*+@a11 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="过程" tabindex="-1"><a class="header-anchor" href="#过程"><span>过程</span></a></h2><ol><li><p>主观下线</p><ul><li>SDOWN（主观不可用）是单个sentinel自己主观上检测到的关于master的状态，从sentinel的角度来看，如果发送了PING心跳后，在一定时间内没有收到合法的回复，就达到了SDOWN的条件。</li><li>sentinel配置文件中的down-after-milliseconds设置了判断主观下线的时间长度</li></ul></li><li><p>客观下线</p><ul><li>ODOWN需要一定数量（quorum）的sentinel，多个哨兵达成一致意见才能认为一个master客观上已经宕机</li></ul></li><li><p>选出领导者哨兵</p><ul><li>通过<strong>Raft算法</strong>选出领导者哨兵进行failover（故障转移）</li></ul><p>log</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code># +sdown master mymaster 192.168.111.169 6379
# +odown master mymaster 192.168.111.169 6379 #quorum 2/2 
# +new-epoch 1
# +try-failover master mymaster 192.168.111.169 6379. 
* Sentinel new configuration saved on disk
# +vote-tor-leader 90bb3177d97028772b2358444etcd407024 t0664 1 
# f60a9cd55dfb521f31bd3038el6fd809aedbcc34 voted for 90bb3177d97028772b2358444efcd407024f0664 1 
# 293208ae686ecfod5e90ba7c66al692061e410e2 voted for 90bb3177d97028772b2358444efcd407024f0664 1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>选出新master主库</p><ul><li><p>新主登基 某个slave被选中成为新master</p><blockquote><p>规则</p><ol><li>redis.conf文件中，优先级<code>slave-priority</code>或者<code>replica-priority</code>最高的从节点(数字越小优先级越高)</li><li>复制偏移位置offset最大的从节点(也就是在master还没有宕机时，复制到数据比其他Slave要多)</li><li>最小Run ID的从节点，字典顺序，ASCII码</li></ol></blockquote></li><li><p>群臣俯首</p><ul><li>执行<code>slaveof no one</code>命令让选出来的从节点成为新的主节点，并通过<code>slave of</code>命令让其他节点成为其从节点</li></ul></li><li><p>旧主拜服</p><ul><li>旧master重连后降级为slave</li></ul></li></ul></li></ol><h2 id="使用建议" tabindex="-1"><a class="header-anchor" href="#使用建议"><span>使用建议</span></a></h2><ol><li>哨兵节点的数量应为多个，哨兵本身应该集群，保证高可用</li><li>哨兵节点的数量应该是奇数</li><li>各个哨兵节点的配置应一致</li><li>如果哨兵节点部署在Docker等容器里面，尤其要注意端口的正确映射<div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>#指定ip与端口
sentinel announce-ip &lt;ip&gt;
sentinel announce-port &lt;port&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>哨兵集群+主从复制，并<strong>不能保证数据零丢失</strong>，所以需要使用集群</li></ol>`,28)]))}const o=i(a,[["render",t],["__file","7.哨兵.html.vue"]]),m=JSON.parse('{"path":"/dbs/redis/7.%E5%93%A8%E5%85%B5.html","title":"哨兵","lang":"zh-CN","frontmatter":{"title":"哨兵","order":8,"description":"7.哨兵 作用 主从监控：监控主从redis库运行是否正常 消息通知：哨兵可以将故障转移的结果发送给客户端 故障转移：如果master异常，则会进行主从切换，将其中一个slave作为新- master 配置中心：客户端通过连接哨兵来获得当前Redis服务的主节点地址 启动 建议至少三个，且为奇数个 或 配置 redis相关 主库建议设置masterau...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/my-docs/dbs/redis/7.%E5%93%A8%E5%85%B5.html"}],["meta",{"property":"og:site_name","content":"一切为了更好的自己"}],["meta",{"property":"og:title","content":"哨兵"}],["meta",{"property":"og:description","content":"7.哨兵 作用 主从监控：监控主从redis库运行是否正常 消息通知：哨兵可以将故障转移的结果发送给客户端 故障转移：如果master异常，则会进行主从切换，将其中一个slave作为新- master 配置中心：客户端通过连接哨兵来获得当前Redis服务的主节点地址 启动 建议至少三个，且为奇数个 或 配置 redis相关 主库建议设置masterau..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-06-14T09:34:35.000Z"}],["meta",{"property":"article:author","content":"憨憨十二"}],["meta",{"property":"article:modified_time","content":"2024-06-14T09:34:35.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"哨兵\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-06-14T09:34:35.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"憨憨十二\\",\\"url\\":\\"https://mister-hope.com\\"}]}"]]},"headers":[{"level":2,"title":"作用","slug":"作用","link":"#作用","children":[]},{"level":2,"title":"启动","slug":"启动","link":"#启动","children":[]},{"level":2,"title":"配置","slug":"配置","link":"#配置","children":[{"level":3,"title":"redis相关","slug":"redis相关","link":"#redis相关","children":[]},{"level":3,"title":"sentinel相关","slug":"sentinel相关","link":"#sentinel相关","children":[]},{"level":3,"title":"最小配置","slug":"最小配置","link":"#最小配置","children":[]}]},{"level":2,"title":"节点异常","slug":"节点异常","link":"#节点异常","children":[{"level":3,"title":"sentinel日志","slug":"sentinel日志","link":"#sentinel日志","children":[]},{"level":3,"title":"配置文件","slug":"配置文件","link":"#配置文件","children":[]}]},{"level":2,"title":"过程","slug":"过程","link":"#过程","children":[]},{"level":2,"title":"使用建议","slug":"使用建议","link":"#使用建议","children":[]}],"git":{"createdTime":1704202784000,"updatedTime":1718357675000,"contributors":[{"name":"consen3464","email":"wangkai@consen.net","commits":1}]},"readingTime":{"minutes":4.84,"words":1452},"filePathRelative":"dbs/redis/7.哨兵.md","localizedDate":"2024年1月2日","autoDesc":true}');export{o as comp,m as data};
