import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as s,b as n,o as l}from"./app-DGSXj59V.js";const i={};function t(d,e){return l(),s("div",null,e[0]||(e[0]=[n(`<h1 id="_6-复制" tabindex="-1"><a class="header-anchor" href="#_6-复制"><span>6.复制</span></a></h1><h1 id="简介" tabindex="-1"><a class="header-anchor" href="#简介"><span>简介</span></a></h1><p>就是主从复制，master以写为主，slave以读为主，当master数据变化的时候，自动将新的数据异步同步到其他的slave数据库</p><h1 id="作用" tabindex="-1"><a class="header-anchor" href="#作用"><span>作用</span></a></h1><ul><li>读写分离</li><li>容灾恢复</li><li>数据备份</li><li>水平扩容支撑高并发</li></ul><h1 id="使用" tabindex="-1"><a class="header-anchor" href="#使用"><span>使用</span></a></h1><p>配从不配主</p><h2 id="权限" tabindex="-1"><a class="header-anchor" href="#权限"><span>权限</span></a></h2><p>master如果配置了requirepass参数，需要密码登录 ，那么slave就要配置masterauth来设置校验密码，否则的话master会拒绝slave的访问请求</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>masterauth password
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="操作命令" tabindex="-1"><a class="header-anchor" href="#操作命令"><span>操作命令</span></a></h2><ul><li><p><code>INFO</code> 查看复制详情</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>INFO 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p><code>REPLICAOF</code></p><p>since 5.0.0</p><p>一般写入进Redis.conf配置文件内，重启后依然生效</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>REPLICAOF <span class="token function">host</span> port
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>特殊</strong></p><p>数据库停止与其他数据库的同步</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>REPLICAOF NO ONE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p><code>SLAVEOF</code></p><p>废弃，被<code>REPLICAOF</code> 替代</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>SLAVEOF <span class="token function">host</span> port
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>特殊</strong></p><p>数据库停止与其他数据库的同步</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>SLAVEOF NO ONE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>每次与master断开之后，都需要重新连接，除非你配置进了redis.conf文件；</p><p>在运行期间修改slave节点的信息，如果该数据库已经是某个主数据库的从数据库，那么会停止和原主数据库的同步关系 转而和新的主数据库同步，重新拜码头</p></li></ul><h1 id="配置文件" tabindex="-1"><a class="header-anchor" href="#配置文件"><span>配置文件</span></a></h1><ul><li><p>主库</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 开启守护进程</span>
daemonize <span class="token function">yes</span>
<span class="token comment"># 注释</span>
<span class="token comment"># bind 127.0.0.1</span>
<span class="token comment"># 关闭保护模式</span>
protected-mode no
<span class="token comment"># 指定端口</span>
port <span class="token number">6379</span>
<span class="token comment"># 指定当前工作目录，dir</span>
<span class="token function">dir</span> /myredis
<span class="token comment"># pid文件配置 用来防止启动多个进程副本。</span>
pidfile /var/run/redis_6379.pid
<span class="token comment"># log文件名字，logfile</span>
<span class="token comment"># 如果日志文件和启动文件同级，这里可以配置为./6379.log，否则这里一定要写绝对路径，是个巨坑！</span>
logfile /myredis/6379.log
<span class="token comment"># requiredpass</span>
requiredpass <span class="token number">11111</span>
<span class="token comment"># rdb</span>
dbfilename dump6379.rdb
<span class="token comment"># aof</span>
appendonly <span class="token function">yes</span>
appendfilename <span class="token punctuation">..</span>.
appenddirname <span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>从库</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 主库host 端口号</span>
replicaof <span class="token number">192.168</span>.*.* <span class="token number">6379</span>
<span class="token comment"># 主库密码</span>
masterauth <span class="token number">11111</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主机shutdown后，<strong>从机不动，原地待命，从机数据可以正常使用，等待主机重启归来</strong></p><p><strong>配置文件，持久稳定永久生效；</strong></p><p><strong>命令，当成生效</strong></p></li></ul><h2 id="薪火相传" tabindex="-1"><a class="header-anchor" href="#薪火相传"><span>薪火相传</span></a></h2><ul><li>上一个slave可以是下一个slave的master，slave同样可以接收其他slaves的连接和同步请求，那么该slave作为了链条中下一个的master,可以有效减轻主master的写压力</li><li>中途变更转向:会清除之前的数据，重新建立主从关系并拷贝最新的</li></ul><h1 id="复制原理和工作流程" tabindex="-1"><a class="header-anchor" href="#复制原理和工作流程"><span><strong>复制原理和工作流程</strong></span></a></h1><h2 id="slave启动-同步初请" tabindex="-1"><a class="header-anchor" href="#slave启动-同步初请"><span>slave启动，同步初请</span></a></h2><ul><li>slave启动成功链接到master后会发送一个sync命令</li><li>slave首次全新连接master，一次完全同步(全量复制)将被自动执行，slave自身原有数据会被master数据覆盖清除</li></ul><h2 id="首次连接-全量复制" tabindex="-1"><a class="header-anchor" href="#首次连接-全量复制"><span>首次连接，全量复制</span></a></h2><ul><li>master节点收到sync命令后会开始在后台保存快照(即RDB持久化，主从复制时会触发RDB)，同时收集所有接收到的用于修改数据集的命令并缓存起来，master节点执行RDB持久化完后，master将RDB快照文件和所有缓存的命令发送到所有slave，以完成一次完全同步</li><li>而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中，从而完成复制初始化</li></ul><h2 id="心跳持续-保持通信" tabindex="-1"><a class="header-anchor" href="#心跳持续-保持通信"><span>心跳持续，保持通信</span></a></h2><p>master发出PING包的周期，默认10秒</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>repl-ping-replica-period <span class="token number">10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="进入平稳-增量复制" tabindex="-1"><a class="header-anchor" href="#进入平稳-增量复制"><span>进入平稳，增量复制</span></a></h3><ul><li>master继续将新的所有收集到的修改命令自动依次传送给slave，完成同步</li></ul><h3 id="从机下线-重连续传" tabindex="-1"><a class="header-anchor" href="#从机下线-重连续传"><span>从机下线，重连续传</span></a></h3><ul><li>master会检查backlog里面的offset，master和slave都会保存一个复制的offset还有一个masterId，offset是保存在backlog中的。</li><li><strong>只会把已经缓存的offset后面的数据复制给slave，类似断点续传</strong></li></ul><h3 id="复制的缺点" tabindex="-1"><a class="header-anchor" href="#复制的缺点"><span>复制的缺点</span></a></h3><ul><li><p>复制延时，信号衰减</p><p>由于所有的写操作都是先在Master上操作，然后同步更新到Slave上，所以从Master同步到Slave机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave机器数量的增加也会使这个问题更加严重。</p></li></ul>`,30)]))}const p=a(i,[["render",t],["__file","6.复制.html.vue"]]),o=JSON.parse('{"path":"/dbs/redis/6.%E5%A4%8D%E5%88%B6.html","title":"复制","lang":"zh-CN","frontmatter":{"title":"复制","order":7,"description":"6.复制 简介 就是主从复制，master以写为主，slave以读为主，当master数据变化的时候，自动将新的数据异步同步到其他的slave数据库 作用 读写分离 容灾恢复 数据备份 水平扩容支撑高并发 使用 配从不配主 权限 master如果配置了requirepass参数，需要密码登录 ，那么slave就要配置masterauth来设置校验密码，...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/my-docs/dbs/redis/6.%E5%A4%8D%E5%88%B6.html"}],["meta",{"property":"og:site_name","content":"一切为了更好的自己"}],["meta",{"property":"og:title","content":"复制"}],["meta",{"property":"og:description","content":"6.复制 简介 就是主从复制，master以写为主，slave以读为主，当master数据变化的时候，自动将新的数据异步同步到其他的slave数据库 作用 读写分离 容灾恢复 数据备份 水平扩容支撑高并发 使用 配从不配主 权限 master如果配置了requirepass参数，需要密码登录 ，那么slave就要配置masterauth来设置校验密码，..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-06-14T09:34:35.000Z"}],["meta",{"property":"article:author","content":"憨憨十二"}],["meta",{"property":"article:modified_time","content":"2024-06-14T09:34:35.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"复制\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-06-14T09:34:35.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"憨憨十二\\",\\"url\\":\\"https://mister-hope.com\\"}]}"]]},"headers":[{"level":2,"title":"权限","slug":"权限","link":"#权限","children":[]},{"level":2,"title":"操作命令","slug":"操作命令","link":"#操作命令","children":[]},{"level":2,"title":"薪火相传","slug":"薪火相传","link":"#薪火相传","children":[]},{"level":2,"title":"slave启动，同步初请","slug":"slave启动-同步初请","link":"#slave启动-同步初请","children":[]},{"level":2,"title":"首次连接，全量复制","slug":"首次连接-全量复制","link":"#首次连接-全量复制","children":[]},{"level":2,"title":"心跳持续，保持通信","slug":"心跳持续-保持通信","link":"#心跳持续-保持通信","children":[{"level":3,"title":"进入平稳，增量复制","slug":"进入平稳-增量复制","link":"#进入平稳-增量复制","children":[]},{"level":3,"title":"从机下线，重连续传","slug":"从机下线-重连续传","link":"#从机下线-重连续传","children":[]},{"level":3,"title":"复制的缺点","slug":"复制的缺点","link":"#复制的缺点","children":[]}]}],"git":{"createdTime":1695377321000,"updatedTime":1718357675000,"contributors":[{"name":"consen3464","email":"wangkai@consen.net","commits":1}]},"readingTime":{"minutes":3.43,"words":1028},"filePathRelative":"dbs/redis/6.复制.md","localizedDate":"2023年9月22日","autoDesc":true}');export{p as comp,o as data};
