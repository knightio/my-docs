---
title: 哨兵
order: 8
---

# 7.哨兵

## 作用

- 主从监控：监控主从redis库运行是否正常
- 消息通知：哨兵可以将故障转移的结果发送给客户端
- 故障转移：如果master异常，则会进行主从切换，将其中一个slave作为新- master
- 配置中心：客户端通过连接哨兵来获得当前Redis服务的主节点地址

## 启动

建议至少三个，且为奇数个

```
redis-sentinel /path/to/sentinel.conf
```

或

```
redis-server /path/to/sentinel.conf --sentinel
```

## 配置

### redis相关

主库建议设置`masterauth`，保证主库掉线后作为从库重连可以连接成功

```
masterauth password
```

### sentinel相关

sentinel能监控多个redis

```
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 60000
sentinel failover-timeout mymaster 180000
sentinel parallel-syncs mymaster 1

sentinel monitor resque 192.168.1.3 6380 4
sentinel down-after-milliseconds resque 10000
sentinel failover-timeout resque 180000
sentinel parallel-syncs resque 5
```

- sentinel monitor `<master-name>` `<ip>` `<port>` `<quorum>`
  - `<quorum>`表示最少有几个哨兵认可**客观**下线，同意故障迁移的法定票数
- sentinel auth-pass `<master-name>` `<password>`
  
- sentinel down-after-milliseconds	指定多少毫秒之后，主节点没有应答哨兵，此时哨兵主观上认为主节点下线
- sentinel parallel-syncs	表示允许并行同步的slave个数，当Master挂了后，哨兵会选出新的Master，此时，剩余的slave会向新的master发起同步数据
- sentinel failover-timeout	故障转移的超时时间，进行故障转移时，如果超过设置的毫秒，表示故障转移失败
- sentinel notification-script	配置当某一事件发生时所需要执行的脚本
- sentinel client-reconfig-script	客户端重新配置主节点参数脚本

### 最小配置

```
bind 0.0.0.0
daemonize yes 
protected-mode no 
port 26379
logfile "/myredis/sentinel26379.log" 
pidfile /var/run/redis-sentinel26379.pid 
dir /myredis
sentinel monitor mymaster 192.168.111.169 6379 2 
sentinel auth-pass mymaster 111111
```

> sentinel 启动后会自动添加部分配置信息
> ```
> # Generated by CONFIG REWRITE
> latency-tracking-info-percentiles 50·99·99.9
> user default on nopass sanitize-payload~*&*+@a11
> sentinel myid·ee7f41ae95e9e80649411a3ea8ada4cfb84c6860 
> sentinel current-epoch 2
> sentinel known-replica mymaster 192.168.199.224 6380 
> sentinel known-replica mymaster 192.168.199.224 6381
> sentinel known-sentinel mymaster 192.168.199.224 26381 90329e511cc9c182385608c21dfb8216c03f0a2e 
> sentinel known-sentinel > > > mymaster 192.168.199.224 26380 fde3aad96cffb46f0c9bf2f25e2f12f4c921bd30 
> ```

## 节点异常

### sentinel日志

```
[018916] 14 Apr 23:32:09.672 # +promoted-slave slave 192.168.199.224:6381 192.168.199.224 6381 @mymaster 192.168.199.224 6379
[018916] 14 Apr 23:32:09.672 # +failover-state-reconf-slaves master mymaster 192.168.199.224 6379
[018916] 14 Apr 23:32:09.734 * +slave-reconf-sent slave 192.168.199.224:6380 192.168.199.224 6380 @mymaster 192.168.199.224 6379
[013636] 14 Apr 23:32:09.734 # +config-update-from sentinel fde3aad96cffb46f0c9bf2f25e2f12f4c921bd30 192.168.199.224 26380@ mymaster 192.168.199.224 6379
[013636] 14 Apr 23:32:09.734 # +switch-master mymaster 192.168.199.224 6379 192.16.199.224 6381
[013636] 14 Apr 23:32:09.734 * +slave slave 192.168.199.224:6380 192.168.199.224 6380@mymaster 192.168.199.224 6381
[013636] 14 Apr 23:32:09.734 * +slave slave 192.168.199.224:6379 192.168.199.224 6379@mymaster 192.168.199.224 6381
[013636] 14 Apr 23:32:9.750  * Sentinel new configuration saved on disk
[018916] 14 Apr 23:32:10.718 * +slave-reconf-inprog slave 192.168.199.224:6380 192.168.199.224 6380@mymaster 192.168.199.224 6379
[018916] 14 Apr 23:32:10.718 * +slave-reconf-done slave 192.168.199.224:6380 192.168.199.224 6380@mymaster 192.168.199.224 6379
[018916] 14 Apr 23:32:10.812 # -odown master mymaster 192.168.199.224 6379 主机真实下线
[018916] 14 Apr 23:32:10.812 # +failover-end master mymaster 192.168.199.224 6379
[018916] 14 Apr 23:32:10.812 # +switch-master mymaster 192.168.199.224 6379 192.168.199.224 6381 选举切换成新主机
[018916] 14 Apr 23:32:10.828 * +slave slave 192.168.199.224:6380 192.168.199.224 6380@mymaster 192.168.199.224 6381
[018916] 14 Apr 23:32:10.828 * ±slave slave 192.168.199.224:6379 192.168.199.224 6379@mymaster 192.168.199.224 6381
[018916] 14 Apr 23:32:10.843 * Sentinel new configuration saved on disk 保存新的sentine1配置文件
[013636] 14 Apr 23:32:14.783 # +sdown slave 192.168.199.224:6379 192.168.199.224 6379@mymaster 192.168.199.224 6381
[018916] 14 Apr 23:32:15.877 # +sdown slave 192.168.199.224:6379 192.168.199.224 6379@mymaster 192.168.199.224 6381
[018916] 14 Apr 23:36:38.308 # +sdown sentinel 90329e511cc9c182385608c21dfb8216c03f0a2e 192.168.199.224 26381 @ mymaster 192.168.199.224 6381
[013636] 14 Apr 23:36:38.340 # +sdown sentinel 90329e511cc9c182385608c21dfb8216c03f0a2e 192.168.199.224 26381@mymaster 192.168.199.224 6381
```

### 配置文件

- master-redis.conf 主库断联后成为从库，但不会自动生成 `masterauth`

    ```
    # Generated by CONFIG REWRITE 2278
    # 从master降级为slave之后，sentinel会制动重写配置文件，让其跟随主机 2279
    replicaof 192.168.111.184 6381 
    save 3600 1 2280
    save 300 100 2281
    save 60 10000 2282
    latency-tracking- info-percentiles 50 99 99.9 2283
    user default on #bcb15f821479b4d5772bd0ca866c00ad5f926e3580720659cc80d39c9d09802a~*&* +@all 
    ```

- slave-redis.conf 从库配置文件会被sentinel修改，从库成为主库，`replicaof` 会被删除

    ```
    ＃主从配置
    #replicaof 192.168.199.224 6381 slave升级为master之后，跟随主机的配置已经没有了 

    masterauth·"123456"
    #Generated by CONFIG REWRITE
    latency-tracking-info-percentiles 50·99·99.9
    user default on sanitize-payload #8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92~*&*+@a11 
    ```

## 过程

1. 主观下线
   
   - SDOWN（主观不可用）是单个sentinel自己主观上检测到的关于master的状态，从sentinel的角度来看，如果发送了PING心跳后，在一定时间内没有收到合法的回复，就达到了SDOWN的条件。
   - sentinel配置文件中的down-after-milliseconds设置了判断主观下线的时间长度

2. 客观下线
   
   - ODOWN需要一定数量（quorum）的sentinel，多个哨兵达成一致意见才能认为一个master客观上已经宕机
  
3. 选出领导者哨兵
   
   - 通过**Raft算法**选出领导者哨兵进行failover（故障转移）
  
    log
    ```
    # +sdown master mymaster 192.168.111.169 6379
    # +odown master mymaster 192.168.111.169 6379 #quorum 2/2 
    # +new-epoch 1
    # +try-failover master mymaster 192.168.111.169 6379. 
    * Sentinel new configuration saved on disk
    # +vote-tor-leader 90bb3177d97028772b2358444etcd407024 t0664 1 
    # f60a9cd55dfb521f31bd3038el6fd809aedbcc34 voted for 90bb3177d97028772b2358444efcd407024f0664 1 
    # 293208ae686ecfod5e90ba7c66al692061e410e2 voted for 90bb3177d97028772b2358444efcd407024f0664 1
    ```
    
4. 选出新master主库
   
   - 新主登基 某个slave被选中成为新master
     
     > 规则
     > 1. redis.conf文件中，优先级`slave-priority`或者`replica-priority`最高的从节点(数字越小优先级越高)
     > 2. 复制偏移位置offset最大的从节点(也就是在master还没有宕机时，复制到数据比其他Slave要多)
     > 3. 最小Run ID的从节点，字典顺序，ASCII码

    - 群臣俯首
      - 执行`slaveof no one`命令让选出来的从节点成为新的主节点，并通过`slave of`命令让其他节点成为其从节点
    - 旧主拜服
      - 旧master重连后降级为slave

## 使用建议

1. 哨兵节点的数量应为多个，哨兵本身应该集群，保证高可用
2. 哨兵节点的数量应该是奇数
3. 各个哨兵节点的配置应一致
4. 如果哨兵节点部署在Docker等容器里面，尤其要注意端口的正确映射
   ```
   #指定ip与端口
   sentinel announce-ip <ip>
   sentinel announce-port <port>
   ```
5. 哨兵集群+主从复制，并**不能保证数据零丢失**，所以需要使用集群